<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Render Sentences from JSON</title>
  <style>
    .word {
      margin-right: 4px;
      cursor: pointer;
      font-size: 24px;
    }
    .sentence {
      margin-bottom: 10px;
    }
    .dropdown {
      margin-left: 8px;
    }
  </style>
</head>
<body>

<h3>Chọn file JSON:</h3>
<input type="file" id="jsonFileInput" accept=".json">
<div id="sentence-container"></div>

<script>


// Hàm ARGB -> CSS
function argbToHex(argb) {
  if (!argb || argb === 'default') return '#000000';
  return '#' + argb.slice(2);
}

// Giải mã unicode escape: \\uXXXX hoặc \\UXXXXXXXX -> ký tự thật
function decodeUnicodeEscape(str) {
  return str.replace(/\\u([\da-f]{4})/gi, (_, grp) =>
    String.fromCharCode(parseInt(grp, 16))
  ).replace(/\\U([\da-f]{8})/gi, (_, grp) =>
    String.fromCodePoint(parseInt(grp, 16))
  );
}

// Render từng câu + xử lý click gọi API gợi ý
function renderSentences(data) {
  const container = document.getElementById('sentence-container');
  container.innerHTML = '';

  const sentences = data["0"];
  sentences.forEach((sentence, sIdx) => {
    const sentenceDiv = document.createElement('div');
    sentenceDiv.className = 'sentence';

    sentence.forEach((word, wIdx) => {
      const span = document.createElement('span');
      span.className = 'word';

      const realText = decodeUnicodeEscape(word.Text || '');
      span.textContent = realText;
      span.style.color = argbToHex(word.Color);
      if (word.Font && word.Font !== 'default') {
        span.style.fontFamily = word.Font;
      }

      // Khi click -> gọi API /suggest?char=...
      span.onclick = () => {
        fetch(`http://127.0.0.1:5000/suggest?char=${encodeURIComponent(realText)}`)
          .then(res => res.json())
          .then(data => {
            const similars = data.suggestions;
            if (!similars || similars.length === 0) {
              alert(`Không có gợi ý cho "${realText}"`);
              return;
            }

            const select = document.createElement('select');
            select.className = 'dropdown';
            similars.forEach(sim => {
              const option = document.createElement('option');
              option.value = sim;
              option.textContent = sim;
              select.appendChild(option);
            });

            select.onchange = () => {
              span.textContent = select.value;
              span.appendChild(select);
            };

            span.appendChild(select);
          })
          .catch(err => {
            alert('Lỗi khi gọi API: ' + err.message);
          });
      };

      sentenceDiv.appendChild(span);
    });

    container.appendChild(sentenceDiv);
  });
}

// Load file JSON chứa câu
document.getElementById('jsonFileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const json = JSON.parse(e.target.result);
      renderSentences(json);
    } catch (err) {
      alert('Lỗi đọc file JSON: ' + err.message);
    }
  };
  reader.readAsText(file, 'UTF-8');
});

</script>

</body>
</html>
